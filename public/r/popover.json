{
  "name": "popover",
  "type": "registry:ui",
  "title": "Popover",
  "description": "Displays rich content in a portal, triggered by a button.",
  "registryDependencies": [
    "tokens",
    "portal",
    "positioning",
    "focus",
    "overlay"
  ],
  "files": [
    {
      "path": "components/ui/popover.tsx",
      "content": "import * as React from \"react\"\nimport {\n  Pressable,\n  type PressableProps,\n  View,\n  type ViewProps,\n} from \"react-native\"\nimport { StyleSheet } from \"react-native-unistyles\"\nimport { FocusScope } from \"../primitives/focus/index.js\"\nimport { DismissLayer } from \"../primitives/overlay/index.js\"\nimport { Portal } from \"../primitives/portal/index.js\"\nimport {\n  type Placement,\n  usePositioning,\n} from \"../primitives/positioning/index.js\"\n\nfunction composeEventHandlers<E>(\n  originalEventHandler?: (event: E) => void,\n  ourEventHandler?: (event: E) => void,\n  { checkForDefaultPrevented = true } = {},\n) {\n  return function handleEvent(event: E) {\n    originalEventHandler?.(event)\n\n    if (\n      checkForDefaultPrevented === false ||\n      // @ts-expect-error - defaultPrevented check\n      !event?.defaultPrevented\n    ) {\n      return ourEventHandler?.(event)\n    }\n  }\n}\n\ntype PopoverContextValue = {\n  open: boolean\n  onOpenChange: (open: boolean) => void\n  triggerRef: React.RefObject<View | null>\n  contentRef: React.RefObject<View | null>\n  modal?: boolean\n}\n\nconst PopoverContext = React.createContext<PopoverContextValue | undefined>(\n  undefined,\n)\n\nfunction usePopover() {\n  const context = React.useContext(PopoverContext)\n  if (!context) {\n    throw new Error(\"usePopover must be used within a Popover\")\n  }\n  return context\n}\n\nexport type PopoverProps = {\n  children: React.ReactNode\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n  modal?: boolean\n}\n\nexport function Popover({\n  children,\n  defaultOpen = false,\n  open: openProp,\n  onOpenChange,\n  modal = true,\n}: PopoverProps) {\n  const [open, setOpen] = React.useState(defaultOpen)\n  const triggerRef = React.useRef<View>(null)\n  const contentRef = React.useRef<View>(null)\n\n  const isControlled = openProp !== undefined\n  const isOpen = isControlled ? openProp : open\n\n  const handleOpenChange = React.useCallback(\n    (newOpen: boolean) => {\n      if (!isControlled) {\n        setOpen(newOpen)\n      }\n      onOpenChange?.(newOpen)\n    },\n    [isControlled, onOpenChange],\n  )\n\n  return (\n    <PopoverContext.Provider\n      value={{\n        open: !!isOpen,\n        onOpenChange: handleOpenChange,\n        triggerRef,\n        contentRef,\n        modal,\n      }}\n    >\n      {children}\n    </PopoverContext.Provider>\n  )\n}\n\nexport const PopoverTrigger = React.forwardRef<\n  React.ElementRef<typeof Pressable>,\n  PressableProps & { asChild?: boolean }\n>(({ children, asChild, onPress, ...props }, ref) => {\n  const { open, onOpenChange, triggerRef } = usePopover()\n\n  const handlePress = React.useCallback(\n    (e: unknown) => {\n      onOpenChange(!open)\n      // @ts-expect-error - React Native event type\n      onPress?.(e)\n    },\n    [open, onOpenChange, onPress],\n  )\n\n  // Sync ref\n  React.useEffect(() => {\n    if (ref) {\n      if (typeof ref === \"function\") {\n        ref(triggerRef.current)\n      } else {\n        ;(ref as { current: View | null }).current = triggerRef.current\n      }\n    }\n  }, [ref, triggerRef])\n\n  if (asChild && React.isValidElement(children)) {\n    // biome-ignore lint/suspicious/noExplicitAny: Cloning logic\n    return React.cloneElement(children as React.ReactElement<any>, {\n      ref: triggerRef,\n      onPress: composeEventHandlers(\n        // @ts-expect-error - onPress check\n        children.props.onPress,\n        handlePress,\n      ),\n      ...props,\n    })\n  }\n\n  return (\n    <Pressable ref={triggerRef} onPress={handlePress} {...props}>\n      {children}\n    </Pressable>\n  )\n})\n\nPopoverTrigger.displayName = \"PopoverTrigger\"\n\nexport type PopoverContentProps = ViewProps & {\n  side?: Placement\n  sideOffset?: number\n  align?: \"start\" | \"center\" | \"end\"\n  alignOffset?: number\n  avoidCollisions?: boolean\n}\n\nconst styles = StyleSheet.create((theme) => ({\n  content: {\n    zIndex: 50,\n    borderRadius: theme.radius.md,\n    borderWidth: 1,\n    borderColor: theme.colors.border,\n    backgroundColor: theme.colors.popover,\n    padding: 12, // p-4 equivalent\n    shadowColor: theme.colors.foreground, // shadow-md\n    shadowOpacity: 0.1,\n    shadowRadius: 4,\n    elevation: 2,\n  },\n}))\n\nexport const PopoverContent = React.forwardRef<View, PopoverContentProps>(\n  (\n    {\n      children,\n      side = \"bottom\",\n      sideOffset = 4,\n      align = \"center\",\n      alignOffset = 0,\n      avoidCollisions = true,\n      style,\n      ...props\n    },\n    ref,\n  ) => {\n    const { open, onOpenChange, triggerRef, contentRef, modal } = usePopover()\n\n    // Positioning\n    const actualPlacement = align === \"center\" ? side : `${side}-${align}`\n\n    const { position, isPositioned } = usePositioning({\n      anchorRef: triggerRef,\n      contentRef: contentRef,\n      placement: actualPlacement as Placement,\n      offset: sideOffset,\n      alignOffset,\n      flip: avoidCollisions,\n      open,\n    })\n\n    // Sync ref\n    React.useEffect(() => {\n      if (ref) {\n        if (typeof ref === \"function\") {\n          ref(contentRef.current)\n        } else {\n          ;(ref as { current: View | null }).current = contentRef.current\n        }\n      }\n    }, [ref, contentRef])\n\n    if (!open) return null\n\n    return (\n      <Portal>\n        <DismissLayer\n          onDismiss={() => onOpenChange(false)}\n          scrim={modal} // If modal is true, we show backdrop to catch clicks\n          scrimStyle={{ backgroundColor: \"transparent\" }}\n        >\n          <FocusScope trapped={modal} loop={true}>\n            <View\n              ref={contentRef}\n              style={[\n                styles.content,\n                {\n                  position: \"absolute\",\n                  opacity: isPositioned ? 1 : 0,\n                  top: position.top,\n                  left: position.left,\n                },\n                style,\n              ]}\n              {...props}\n            >\n              {children}\n            </View>\n          </FocusScope>\n        </DismissLayer>\n      </Portal>\n    )\n  },\n)\n\nPopoverContent.displayName = \"PopoverContent\"\n",
      "type": "registry:ui"
    }
  ]
}
